# ─── General ──────────────────────────────────────────────────────────────────

set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -g escape-time 0
set -g focus-events on
set -g set-clipboard on

# ─── Prefix ───────────────────────────────────────────────────────────────────

unbind C-b
set -g prefix C-a
bind C-a send-prefix

# ─── Keybindings ──────────────────────────────────────────────────────────────

# Intuitive splits (open in current path)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New windows in current path
bind c new-window -c "#{pane_current_path}"

# Quick reload
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ─── Fzf integrations ─────────────────────────────────────────────────────────

# Fuzzy grab text from pane (like extrakto)
# Captures scrollback, extracts tokens (urls, paths, hashes, words), fuzzy-pick to paste
bind Tab display-popup -w 80% -h 60% -E "\
  tmux capture-pane -t '{last}' -pS -5000 | \
  grep -oE '(https?://[^ ]+|/[^ ]+|[a-zA-Z0-9_./-]+:[0-9]+|[a-f0-9]{7,40}|[^ ]+)' | \
  sort -u | \
  fzf --prompt='grab > ' --reverse --no-info | \
  tr -d '\n' | \
  tmux load-buffer - && tmux paste-buffer -t '{last}'"

# Session switcher
bind s display-popup -w 60% -h 50% -E "\
  tmux list-sessions -F '#{session_name}' | \
  fzf --prompt='session > ' --reverse --no-info \
      --preview 'tmux list-windows -t {} -F \"  #{window_index}: #{window_name} (#{pane_current_command})\"' | \
  xargs -r tmux switch-client -t"

# Window switcher (across all sessions)
bind w display-popup -w 70% -h 50% -E "\
  tmux list-windows -a -F '#{session_name}:#{window_index}  #{window_name} (#{pane_current_command})' | \
  fzf --prompt='window > ' --reverse --no-info | \
  sed 's/  .*//' | \
  xargs -r tmux switch-client -t"

# Kill session picker
bind X display-popup -w 50% -h 40% -E "\
  tmux list-sessions -F '#{session_name}' | \
  fzf --prompt='kill session > ' --reverse --no-info --multi | \
  xargs -r -I {} tmux kill-session -t {}"

# SSH launcher — merges ~/.ssh/config hosts + tailscale peers, opens new window with ssh
# Prompts for username (enter to skip if host already has User in ssh config)
bind S display-popup -w 50% -h 40% -E 'bash -c "\
  host=\$({ grep -i \"^Host \" ~/.ssh/config 2>/dev/null | awk \"{print \\\$2}\" | grep -v \"[*?]\"; \
    command -v tailscale >/dev/null && tailscale status --json 2>/dev/null | \
    grep -oP \"\\\"DNSName\\\":\\s*\\\"\\K[^\\\"]+\" | sed \"s/\\\\.\\$//\"; \
  } | sort -u | fzf --prompt=\"ssh > \" --reverse --no-info) || exit 0; \
  [ -z \"\$host\" ] && exit 0; \
  printf \"user (enter to skip): \"; read -r user; \
  if [ -n \"\$user\" ]; then target=\"\$user@\$host\"; else target=\"\$host\"; fi; \
  tmux new-window -n \"\$host\" \"ssh \$target\""'

# Command history search — paste a previous command
bind H display-popup -w 80% -h 60% -E "\
  (cat ~/.zsh_history 2>/dev/null || cat ~/.bash_history 2>/dev/null) | \
  sed 's/^[^;]*;//' | \
  tac | awk '!seen[\$0]++' | \
  fzf --prompt='history > ' --reverse --no-info | \
  tr -d '\n' | \
  tmux load-buffer - && tmux paste-buffer"

# ─── Help ─────────────────────────────────────────────────────────────────────

bind / display-popup -w 52 -h 22 -E "sh ~/.dotfiles/config/tmux/help.sh"

# ─── Quality of life ─────────────────────────────────────────────────────────

# Longer display time for messages and pane indicators
set -g display-time 2000
set -g display-panes-time 2000

# Activity monitoring (subtle dot on window tab, no bell)
setw -g monitor-activity on
set -g visual-activity off

# Automatic window rename based on running command
setw -g automatic-rename on
setw -g automatic-rename-format "#{pane_current_command}"

# ─── Ayu Mirage palette ──────────────────────────────────────────────────────
#
#   bg       = #242936 (base)
#   surface  = #2d3441 (panels / raised elements)
#   overlay  = #3b4261 (selection / highlights)
#   text     = #cccac2 (foreground)
#   subtext  = #8a9199 (comments / muted)
#   accent   = #ffcc66 (golden yellow)
#   orange   = #ffad66
#   peach    = #f28779 (salmon)
#   green    = #d5ff80
#   cyan     = #5ccfe6
#   blue     = #73d0ff
#   purple   = #dfbfff

# ─── Status bar ───────────────────────────────────────────────────────────────

set -g status on
set -g status-position bottom
set -g status-interval 5
set -g status-justify left
set -g status-style "bg=#242936,fg=#cccac2"

# Left: session name
set -g status-left-length 40
set -g status-left "#[fg=#242936,bg=#ffcc66,bold]  #S #[fg=#ffcc66,bg=#242936,nobold] "

# Right: current command, hostname, date, time — kept on a single surface strip
set -g status-right-length 120
set -g status-right "\
#[fg=#2d3441,bg=#242936]\
#[fg=#8a9199,bg=#2d3441] #{pane_current_command} \
#[fg=#cccac2,bg=#2d3441]│ 󰒋 #H \
#[fg=#8a9199,bg=#2d3441]│  %b %d \
#[fg=#ffcc66,bg=#2d3441,bold]│  %H:%M \
#[fg=#2d3441,bg=#242936]"

# ─── Window tabs ──────────────────────────────────────────────────────────────

setw -g window-status-format "#[fg=#8a9199,bg=#242936]  #I:#W "
setw -g window-status-current-format "#[fg=#242936,bg=#2d3441]#[fg=#ffcc66,bg=#2d3441,bold] #I:#W #[fg=#2d3441,bg=#242936]"
setw -g window-status-separator ""

# ─── Pane borders ─────────────────────────────────────────────────────────────

set -g pane-border-style "fg=#2d3441"
set -g pane-active-border-style "fg=#ffcc66"

# ─── Message / Command prompt ─────────────────────────────────────────────────

set -g message-style "bg=#2d3441,fg=#cccac2"
set -g message-command-style "bg=#2d3441,fg=#cccac2"

# ─── Copy mode highlight ─────────────────────────────────────────────────────

setw -g mode-style "bg=#3b4261,fg=#cccac2"

# ─── Clock ────────────────────────────────────────────────────────────────────

setw -g clock-mode-colour "#ffcc66"
